<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o Eleitoral - Sistema de Equipes</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2, h3 { color: #0056b3; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; }
        
        /* TELA DE LOGIN */
        #telaLogin { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,50,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .box-login { background: white; padding: 40px; border-radius: 10px; text-align: center; color: #333; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .btn-acesso { width: 100%; padding: 15px; margin: 10px 0; border: none; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 5px; transition: 0.3s; }
        .btn-membro { background-color: #28a745; color: white; }
        .btn-admin { background-color: #007bff; color: white; }
        .btn-acesso:hover { opacity: 0.8; transform: scale(1.02); }

        /* Formul√°rio e Alertas */
        .alerta-indicacao { background-color: #d4edda; color: #155724; padding: 12px; border-radius: 5px; margin-bottom: 20px; display: none; border: 1px solid #c3e6cb; font-weight: bold; }
        .form-group { display: grid; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; }
        .grid-campos { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; }
        input, button, select { padding: 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 15px; }
        button { background-color: #007bff; color: white; font-weight: bold; cursor: pointer; border: none; transition: 0.2s; }
        button:hover { background-color: #0056b3; }
        .area-link { background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 10px 0; display: none; border: 1px solid #b2d7ff; }
        
        /* Rankings */
        .ranking-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; margin-bottom: 20px; }
        .ranking-box { background: linear-gradient(135deg, #fff 0%, #f1f8ff 100%); border: 1px solid #cce5ff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ranking-titulo { font-weight: bold; color: #004085; border-bottom: 1px solid #b8daff; padding-bottom: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .lista-ranking { list-style: none; padding: 0; margin: 0; }
        .lista-ranking li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .lista-ranking li:last-child { border-bottom: none; }

        /* Tabela Visual */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; background: white; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #0056b3; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .status-ativo { background-color: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; }
        .status-inativo { background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; }
        .badge-lider { background: #6f42c1; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
        .badge-admin { background: #ffc107; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .contador-infinito { color: #28a745; font-weight: bold; }
        
        /* Painel Administrativo */
        #painelAdmin { display: none; }
        .secao-eventos { background: #fff3cd; padding: 20px; border-radius: 8px; border: 1px solid #ffeeba; margin-top: 40px; }
        .secao-historico { background: #d1ecf1; padding: 20px; border-radius: 8px; border: 1px solid #bee5eb; margin-top: 40px; }
        .btn-confirmar { background-color: #28a745; font-size: 11px; padding: 6px 10px; margin-right: 5px; }
        .btn-promover { background-color: #17a2b8; font-size: 11px; padding: 6px 10px; margin-right: 5px; }
        .btn-excluir { background-color: #dc3545; font-size: 11px; padding: 6px 10px; }
    </style>
</head>
<body>

<div id="telaLogin">
    <div class="box-login">
        <h1 style="color:#0056b3; margin-bottom:5px;">Gest√£o Eleitoral</h1>
        <p style="margin-bottom:20px; color:#666;">Selecione o tipo de acesso:</p>
        <button class="btn-acesso btn-membro" onclick="acessarComo('membro')">üë§ ACESSO MEMBRO</button>
        <button class="btn-acesso btn-admin" onclick="acessarComo('admin')">üëë RECEP√á√ÉO / ADMIN</button>
    </div>
</div>

<div class="container">
    <h2>üöÄ Cadastro e Gest√£o de Equipe</h2>

    <div id="alertaRef" class="alerta-indicacao">
        üì¢ Voc√™ est√° sendo indicado por: <strong id="nomeIndicador">...</strong>
    </div>
    
    <div class="form-group">
        <input type="text" id="nome" placeholder="Nome Completo">
        <input type="text" id="cidade" placeholder="Cidade">
        <div class="grid-campos">
            <input type="number" id="titulo" placeholder="T√≠tulo de Eleitor">
            <input type="number" id="zona" placeholder="Zona">
            <input type="number" id="secao" placeholder="Se√ß√£o">
            <button onclick="cadastrar()">CADASTRAR E GERAR LINK</button>
        </div>
    </div>

    <div id="areaLink" class="area-link">
        <strong>üîó Seu Link de Convite:</strong> <span id="linkGerado" style="color: #0056b3; font-family: monospace; font-weight: bold;"></span>
        <button onclick="copiarLink()" style="padding: 5px 12px; font-size: 12px; background: #28a745; margin-left: 10px;">Copiar Link</button>
    </div>

    <div class="ranking-container">
        <div class="ranking-box">
            <div class="ranking-titulo">üèÜ TOP 5 - GERAL (Desde o In√≠cio)</div>
            <ul id="rankingGeral" class="lista-ranking"></ul>
        </div>
        <div class="ranking-box">
            <div class="ranking-titulo">üìÖ TOP 5 - ANUAL (<span id="anoAtual"></span>)</div>
            <ul id="rankingAno" class="lista-ranking"></ul>
        </div>
    </div>

    <div style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-top: 20px; display: flex; align-items: center; gap: 10px; border: 1px solid #dee2e6;">
        <strong>üîç Visualizar Rede de:</strong>
        <select id="selectLider" onchange="atualizarTabelaGeral()" style="flex-grow: 1;"></select>
    </div>

    <table id="tabelaDados">
        <thead>
            <tr>
                <th>Status</th>
                <th>Nome</th>
                <th>Cargo</th>
                <th>Cidade</th>
                <th>T√≠tulo</th>
                <th>Indicados</th>
                <th>L√≠der</th>
                <th id="colunaAcoes">A√ß√µes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="painelAdmin">
        <div class="secao-eventos">
            <h3>üéâ Controle de Recep√ß√£o e Eventos</h3>
            <input type="text" id="nomeDaFesta" style="width: 98%; margin-bottom: 10px; font-weight: bold;" placeholder="Digite o nome do Evento Atual" oninput="localStorage.setItem('nomeFestaSalvo', this.value)">
            <div id="numConfirmados" style="font-weight: bold; margin-bottom: 10px; color: #856404;">Confirmados na fila: 0</div>
            
            <table id="tabelaEvento">
                <thead><tr><th>Nome</th><th>Cidade</th><th>A√ß√£o</th></tr></thead>
                <tbody></tbody>
            </table>
            
            <div style="margin-top:15px;">
                <button onclick="fecharESalvarEvento()" style="background-color: #17a2b8;">üíæ Finalizar e Salvar Evento</button>
                <button onclick="exportarExcel()" style="background-color: #1d6f42;">üì• Baixar Lista (Excel/CSV)</button>
            </div>
        </div>

        <div class="secao-historico">
            <h3>üìú Hist√≥rico de Eventos Realizados</h3>
            <div id="listaHistorico"></div>
        </div>
    </div>
</div>

<script>
    // BANCO DE DADOS LOCAL
    let bancoPessoas = JSON.parse(localStorage.getItem('bancoPessoas')) || [];
    let listaEvento = JSON.parse(localStorage.getItem('listaEvento')) || [];
    let historicoEventos = JSON.parse(localStorage.getItem('historicoEventos')) || [];
    let isAdmin = false;

    const SENHA_MESTRA = "584270Admin$";

    // Inicializa√ß√£o
    document.getElementById('anoAtual').innerText = new Date().getFullYear();
    document.getElementById('nomeDaFesta').value = localStorage.getItem('nomeFestaSalvo') || "";

    // Verifica√ß√£o de Indica√ß√£o via URL
    const urlParams = new URLSearchParams(window.location.search);
    const refDoLink = urlParams.get('ref');
    if (refDoLink) {
        const indicador = bancoPessoas.find(p => p.titulo === refDoLink);
        if (indicador) {
            document.getElementById('alertaRef').style.display = 'block';
            document.getElementById('nomeIndicador').innerText = indicador.nome;
        }
    }

    // LOGIN
    function acessarComo(tipo) {
        if (tipo === 'admin') {
            const senha = prompt("Acesso Restrito. Digite a senha:");
            if (senha === SENHA_MESTRA) {
                isAdmin = true;
                document.getElementById('painelAdmin').style.display = 'block';
                document.getElementById('telaLogin').style.display = 'none';
                atualizarTabelaGeral();
            } else {
                alert("Senha incorreta!");
            }
        } else {
            isAdmin = false;
            document.getElementById('colunaAcoes').style.display = 'none';
            document.getElementById('telaLogin').style.display = 'none';
            atualizarTabelaGeral();
        }
    }

    // CADASTRO
    function cadastrar() {
        const nome = document.getElementById('nome').value;
        const cidade = document.getElementById('cidade').value;
        const titulo = document.getElementById('titulo').value;
        const zona = document.getElementById('zona').value;
        const secao = document.getElementById('secao').value;

        if (!nome || !titulo) return alert("Por favor, preencha Nome e T√≠tulo!");
        if (bancoPessoas.some(p => p.titulo === titulo)) return alert("Este T√≠tulo j√° est√° cadastrado!");

        bancoPessoas.push({ 
            nome, cidade, titulo, zona, secao, 
            indicadoPor: refDoLink || "direto",
            dataCadastro: new Date().toISOString(),
            cargo: "Membro"
        });
        
        localStorage.setItem('bancoPessoas', JSON.stringify(bancoPessoas));
        
        const link = `${window.location.href.split('?')[0]}?ref=${titulo}`;
        document.getElementById('linkGerado').innerText = link;
        document.getElementById('areaLink').style.display = 'block';
        
        popularFiltroLideres();
        atualizarRankings();
        atualizarTabelaGeral();
        limparCampos();
    }

    // GEST√ÉO DE CARGOS
    function promoverAdmin(titulo) {
        if(!isAdmin) return;
        const idx = bancoPessoas.findIndex(p => p.titulo === titulo);
        if(idx !== -1) {
            bancoPessoas[idx].cargo = (bancoPessoas[idx].cargo === "Admin") ? "Membro" : "Admin";
            localStorage.setItem('bancoPessoas', JSON.stringify(bancoPessoas));
            atualizarTabelaGeral();
        }
    }

    // TABELA PRINCIPAL
    function atualizarTabelaGeral() {
        const tbody = document.querySelector('#tabelaDados tbody');
        const filtro = document.getElementById('selectLider').value;
        tbody.innerHTML = "";
        
        let lista = (filtro === 'todos') ? bancoPessoas : bancoPessoas.filter(p => p.indicadoPor === filtro);

        lista.forEach(p => {
            const count = bancoPessoas.filter(m => m.indicadoPor === p.titulo).length;
            const status = count >= 10 ? '<span class="status-ativo">ATIVO</span>' : '<span class="status-inativo">INATIVO</span>';
            const indicadosTexto = count >= 10 ? `üöÄ ${count}` : `${count} / 10`;
            const cargoHtml = p.cargo === "Admin" ? '<span class="badge-admin">ADMIN</span>' : '<span style="color:#777">Membro</span>';
            const lider = bancoPessoas.find(l => l.titulo === p.indicadoPor);

            let acoesHtml = "";
            if (isAdmin) {
                acoesHtml = `<td>
                    <button class="btn-confirmar" onclick="confirmarPresenca('${p.titulo}')">PRESEN√áA</button>
                    <button class="btn-promover" onclick="promoverAdmin('${p.titulo}')">CARGO</button>
                    <button class="btn-excluir" onclick="excluirMembro('${p.titulo}')">X</button>
                </td>`;
                document.getElementById('colunaAcoes').style.display = '';
            }

            const tr = tbody.insertRow();
            tr.innerHTML = `
                <td>${status}</td>
                <td><b>${p.nome}</b></td>
                <td>${cargoHtml}</td>
                <td>${p.cidade}</td>
                <td>${p.titulo}</td>
                <td style="text-align:center">${indicadosTexto}</td>
                <td><span class="badge-lider">${lider ? lider.nome : 'Direto'}</span></td>
                ${acoesHtml}
            `;
        });
    }

    // RANKINGS
    function atualizarRankings() {
        const contGeral = {};
        const contAno = {};
        const anoAtual = new Date().getFullYear();

        bancoPessoas.forEach(p => {
            if(p.indicadoPor !== "direto") {
                contGeral[p.indicadoPor] = (contGeral[p.indicadoPor] || 0) + 1;
                if(p.dataCadastro && new Date(p.dataCadastro).getFullYear() === anoAtual) {
                    contAno[p.indicadoPor] = (contAno[p.indicadoPor] || 0) + 1;
                }
            }
        });
        renderRank(contGeral, 'rankingGeral');
        renderRank(contAno, 'rankingAno');
    }

    function renderRank(obj, id) {
        const arr = Object.keys(obj).map(t => ({ n: bancoPessoas.find(p=>p.titulo===t)?.nome || t, v: obj[t] }))
                    .sort((a,b) => b.v - a.v).slice(0,5);
        const el = document.getElementById(id); el.innerHTML = "";
        if(arr.length === 0) el.innerHTML = "<li>Sem dados</li>";
        arr.forEach((i, idx) => {
            let medalha = idx === 0 ? "ü•á" : idx === 1 ? "ü•à" : idx === 2 ? "ü•â" : `#${idx+1}`;
            el.innerHTML += `<li><span>${medalha} ${i.n}</span> <b>${i.v} indicados</b></li>`;
        });
    }

    // EVENTOS E EXCEL
    function confirmarPresenca(titulo) {
        const p = bancoPessoas.find(x => x.titulo === titulo);
        if (!p || listaEvento.some(e => e.titulo === p.titulo)) return;
        listaEvento.push(p);
        localStorage.setItem('listaEvento', JSON.stringify(listaEvento));
        atualizarTabelaEvento();
    }

    function atualizarTabelaEvento() {
        const tbody = document.querySelector('#tabelaEvento tbody');
        tbody.innerHTML = "";
        document.getElementById('numConfirmados').innerText = "Confirmados no evento: " + listaEvento.length;
        listaEvento.forEach(p => {
            const tr = tbody.insertRow();
            tr.innerHTML = `<td>${p.nome}</td><td>${p.cidade}</td><td><button class="btn-excluir" onclick="removerPresenca('${p.titulo}')">Remover</button></td>`;
        });
    }

    function removerPresenca(titulo) {
        listaEvento = listaEvento.filter(e => e.titulo !== titulo);
        localStorage.setItem('listaEvento', JSON.stringify(listaEvento));
        atualizarTabelaEvento();
    }

    function fecharESalvarEvento() {
        const nome = document.getElementById('nomeDaFesta').value;
        if(!nome || listaEvento.length === 0) return alert("Preencha o nome do evento e adicione pessoas!");
        historicoEventos.push({ id: Date.now(), nome, data: new Date().toLocaleString(), participantes: [...listaEvento] });
        localStorage.setItem('historicoEventos', JSON.stringify(historicoEventos));
        listaEvento = []; localStorage.setItem('listaEvento', "[]");
        document.getElementById('nomeDaFesta').value = "";
        localStorage.removeItem('nomeFestaSalvo');
        atualizarTabelaEvento(); renderizarHistorico();
    }

    function renderizarHistorico() {
        const div = document.getElementById('listaHistorico'); div.innerHTML = "";
        historicoEventos.slice().reverse().forEach(ev => {
            div.innerHTML += `<div style="background:white; padding:10px; margin-bottom:5px; border-radius:5px; border-left:4px solid #17a2b8; display:flex; justify-content:space-between;">
                <span><strong>${ev.data}</strong> - ${ev.nome} (${ev.participantes.length} presentes)</span>
                <button onclick="excluirHist(${ev.id})" class="btn-excluir">Apagar</button>
            </div>`;
        });
    }

    function excluirHist(id) {
        if(confirm("Excluir este registro de hist√≥rico?")) {
            historicoEventos = historicoEventos.filter(e => e.id !== id);
            localStorage.setItem('historicoEventos', JSON.stringify(historicoEventos));
            renderizarHistorico();
        }
    }

    function excluirMembro(titulo) {
        if(confirm("Deseja apagar este cadastro permanentemente?")) {
            bancoPessoas = bancoPessoas.filter(p => p.titulo !== titulo);
            localStorage.setItem('bancoPessoas', JSON.stringify(bancoPessoas));
            atualizarTabelaGeral(); popularFiltroLideres(); atualizarRankings();
        }
    }

    function exportarExcel() {
        let csv = `Nome;Cidade;Titulo;Zona;Secao\n`;
        listaEvento.forEach(p => csv += `${p.nome};${p.cidade};${p.titulo};${p.zona};${p.secao}\n`);
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "lista_presenca.csv"; a.click();
    }

    function popularFiltroLideres() {
        const select = document.getElementById('selectLider');
        select.innerHTML = '<option value="todos">-- Mostrar Todos --</option><option value="direto">Cadastros Diretos (Sem L√≠der)</option>';
        const lideres = [...new Set(bancoPessoas.map(p => p.indicadoPor))].filter(r => r !== 'direto');
        lideres.forEach(t => {
            const l = bancoPessoas.find(p => p.titulo === t);
            if(l) select.innerHTML += `<option value="${t}">Equipe de: ${l.nome}</option>`;
        });
    }

    function copiarLink() { navigator.clipboard.writeText(document.getElementById('linkGerado').innerText); alert("Link copiado para a √°rea de transfer√™ncia!"); }
    function limparCampos() { document.querySelectorAll('.form-group input').forEach(i => i.value = ''); }

    // Execu√ß√£o Inicial
    popularFiltroLideres(); 
    atualizarRankings(); 
    renderizarHistorico(); 
    atualizarTabelaEvento();
    atualizarTabelaGeral();
</script>

</body>
</html>