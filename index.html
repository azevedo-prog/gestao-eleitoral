<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Gest√£o - Seguran√ßa Ativada</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2, h3 { color: #0056b3; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; }
        .alerta-indicacao { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 20px; display: none; border: 1px solid #c3e6cb; }
        .form-group { display: grid; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .grid-campos { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; }
        input, button, select { padding: 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 15px; }
        button { background-color: #007bff; color: white; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
        button:hover { background-color: #0056b3; }
        .area-link { background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 10px 0; display: none; border: 1px solid #b2d7ff; }
        .filtro-secao { background: #e9ecef; padding: 15px; border-radius: 8px; margin-top: 20px; display: flex; align-items: center; gap: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; background: white; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #0056b3; color: white; }
        .status-ativo { background-color: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .status-inativo { background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .badge-lider { background: #6f42c1; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .btn-confirmar { background-color: #28a745; font-size: 11px; padding: 5px 8px; margin-right: 5px; }
        .btn-excluir { background-color: #dc3545; font-size: 11px; padding: 5px 8px; }
        .secao-eventos { background: #fff3cd; padding: 20px; border-radius: 8px; border: 1px solid #ffeeba; margin-top: 40px; }
        .secao-historico { background: #d1ecf1; padding: 20px; border-radius: 8px; border: 1px solid #bee5eb; margin-top: 40px; }
        .item-historico { background: white; padding: 15px; margin-bottom: 10px; border-radius: 5px; border-left: 5px solid #17a2b8; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ Gest√£o de Equipe (Link por Nome)</h2>

    <div id="alertaRef" class="alerta-indicacao">
        üì¢ Voc√™ est√° entrando atrav√©s do convite de: <strong id="nomeIndicador">...</strong>
    </div>
    
    <div class="form-group">
        <input type="text" id="nome" placeholder="Nome Completo">
        <input type="text" id="cidade" placeholder="Cidade">
        <div class="grid-campos">
            <input type="number" id="titulo" placeholder="T√≠tulo de Eleitor">
            <input type="number" id="zona" placeholder="Zona">
            <input type="number" id="secao" placeholder="Se√ß√£o">
            <button onclick="cadastrar()">CADASTRAR E GERAR LINK</button>
        </div>
    </div>

    <div id="areaLink" class="area-link">
        <strong>üîó Link de Convite Seguro:</strong> <br>
        <span id="linkGerado" style="word-break: break-all; color: #0056b3; font-family: monospace;"></span>
        <button onclick="copiarLink()" style="padding: 5px; font-size: 11px; background: #28a745; margin-left: 10px;">Copiar Link</button>
    </div>

    <div class="filtro-secao">
        <strong>üîç Filtrar por L√≠der:</strong>
        <select id="selectLider" onchange="atualizarTabelaGeral()" style="flex-grow: 1;"></select>
    </div>

    <table id="tabelaDados">
        <thead>
            <tr>
                <th>Status</th>
                <th>Nome</th>
                <th>Cidade</th>
                <th>T√≠tulo</th>
                <th>Zona/Se√ß√£o</th>
                <th>Indicados</th>
                <th>L√≠der</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="secao-eventos">
        <h3>üéâ Evento Atual</h3>
        <input type="text" id="nomeDaFesta" style="width: 98%; margin-bottom: 15px;" placeholder="Nome da Festa" oninput="localStorage.setItem('nomeFestaSalvo', this.value)">
        <div style="font-weight: bold; margin-bottom: 10px;">Confirmados: <span id="numConfirmados">0</span></div>
        <table id="tabelaEvento">
            <thead><tr><th>Nome</th><th>Cidade</th><th>A√ß√£o</th></tr></thead>
            <tbody></tbody>
        </table>
        <div style="margin-top: 15px;">
            <button onclick="fecharESalvarEvento()" style="background-color: #17a2b8;">üíæ Salvar Hist√≥rico</button>
            <button onclick="exportarExcel()" style="background-color: #1d6f42;">üì• Excel</button>
        </div>
    </div>

    <div class="secao-historico">
        <h3>üìú Hist√≥rico</h3>
        <div id="listaHistorico"></div>
    </div>
</div>

<script>
    let bancoPessoas = JSON.parse(localStorage.getItem('bancoPessoas')) || [];
    let listaEvento = JSON.parse(localStorage.getItem('listaEvento')) || [];
    let historicoEventos = JSON.parse(localStorage.getItem('historicoEventos')) || [];

    const urlParams = new URLSearchParams(window.location.search);
    const refDoLink = urlParams.get('ref');

    if (refDoLink) {
        const indicador = bancoPessoas.find(p => criarSlug(p.nome) === refDoLink);
        if (indicador) {
            document.getElementById('alertaRef').style.display = 'block';
            document.getElementById('nomeIndicador').innerText = indicador.nome;
        }
    }

    function criarSlug(nome) {
        return nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');
    }

    function cadastrar() {
        const nome = document.getElementById('nome').value.trim();
        const cidade = document.getElementById('cidade').value;
        const titulo = document.getElementById('titulo').value;
        const zona = document.getElementById('zona').value;
        const secao = document.getElementById('secao').value;

        if (!nome || !titulo) return alert("Nome e T√≠tulo s√£o obrigat√≥rios!");
        
        const slugNome = criarSlug(nome);
        if (bancoPessoas.some(p => criarSlug(p.nome) === slugNome)) {
            return alert("Este nome j√° possui um link ativo ou √© muito similar a um existente!");
        }

        const novoMembro = { 
            nome, 
            cidade, 
            titulo, 
            zona, 
            secao, 
            indicadoPor: refDoLink || "direto",
            slug: slugNome 
        };

        bancoPessoas.push(novoMembro);
        localStorage.setItem('bancoPessoas', JSON.stringify(bancoPessoas));

        const urlBase = window.location.href.split('?')[0];
        document.getElementById('linkGerado').innerText = `${urlBase}?ref=${slugNome}`;
        document.getElementById('areaLink').style.display = 'block';

        popularFiltroLideres();
        atualizarTabelaGeral();
        limparCampos();
    }

    function excluirMembro(titulo) {
        if(confirm("Excluir este membro?")) {
            bancoPessoas = bancoPessoas.filter(p => p.titulo !== titulo);
            localStorage.setItem('bancoPessoas', JSON.stringify(bancoPessoas));
            popularFiltroLideres();
            atualizarTabelaGeral();
        }
    }

    function popularFiltroLideres() {
        const select = document.getElementById('selectLider');
        select.innerHTML = '<option value="todos">-- Todos --</option><option value="direto">Sem L√≠der</option>';
        const lideresUnicos = [...new Set(bancoPessoas.map(p => p.indicadoPor))].filter(r => r !== 'direto');
        lideresUnicos.forEach(slugLider => {
            const l = bancoPessoas.find(p => p.slug === slugLider);
            if(l) select.innerHTML += `<option value="${slugLider}">Equipe de: ${l.nome}</option>`;
        });
    }

    function atualizarTabelaGeral() {
        const tbody = document.querySelector('#tabelaDados tbody');
        const filtro = document.getElementById('selectLider').value;
        tbody.innerHTML = "";
        let lista = (filtro === 'todos') ? bancoPessoas : bancoPessoas.filter(p => p.indicadoPor === filtro);

        lista.forEach(p => {
            const countIndicados = bancoPessoas.filter(m => m.indicadoPor === p.slug).length;
            const statusHtml = countIndicados >= 10 ? '<span class="status-ativo">ATIVO</span>' : '<span class="status-inativo">INATIVO</span>';
            const lider = bancoPessoas.find(l => l.slug === p.indicadoPor);

            const linha = tbody.insertRow();
            linha.innerHTML = `
                <td>${statusHtml}</td>
                <td><b>${p.nome}</b></td>
                <td>${p.cidade}</td>
                <td>${p.titulo}</td>
                <td>${p.zona}/${p.secao}</td>
                <td style="text-align:center"><b>${countIndicados}</b> / 10</td>
                <td><span class="badge-lider">${lider ? lider.nome : 'Nenhum'}</span></td>
                <td>
                    <button class="btn-confirmar" onclick="confirmarPresenca('${p.titulo}')">PRESEN√áA</button>
                    <button class="btn-excluir" onclick="excluirMembro('${p.titulo}')">X</button>
                </td>`;
        });
    }

    function confirmarPresenca(titulo) {
        const p = bancoPessoas.find(x => x.titulo === titulo);
        if (listaEvento.some(e => e.titulo === p.titulo)) return;
        listaEvento.push(p);
        localStorage.setItem('listaEvento', JSON.stringify(listaEvento));
        atualizarTabelaEvento();
    }

    function removerPresencaAtual(titulo) {
        listaEvento = listaEvento.filter(e => e.titulo !== titulo);
        localStorage.setItem('listaEvento', JSON.stringify(listaEvento));
        atualizarTabelaEvento();
    }

    function atualizarTabelaEvento() {
        const tbody = document.querySelector('#tabelaEvento tbody');
        tbody.innerHTML = "";
        document.getElementById('numConfirmados').innerText = listaEvento.length;
        listaEvento.forEach(p => {
            const linha = tbody.insertRow();
            linha.innerHTML = `<td>${p.nome}</td><td>${p.cidade}</td>
            <td><button class="btn-excluir" onclick="removerPresencaAtual('${p.titulo}')">Remover</button></td>`;
        });
    }

    function fecharESalvarEvento() {
        const nome = document.getElementById('nomeDaFesta').value;
        if(!nome || listaEvento.length === 0) return alert("D√™ um nome e adicione pessoas!");
        historicoEventos.push({ id: Date.now(), nome: nome, data: new Date().toLocaleString(), participantes: [...listaEvento] });
        localStorage.setItem('historicoEventos', JSON.stringify(historicoEventos));
        listaEvento = [];
        localStorage.setItem('listaEvento', "[]");
        document.getElementById('nomeDaFesta').value = "";
        atualizarTabelaEvento();
        renderizarHistorico();
    }

    function renderizarHistorico() {
        const div = document.getElementById('listaHistorico');
        div.innerHTML = "";
        historicoEventos.slice().reverse().forEach(ev => {
            div.innerHTML += `
                <div class="item-historico">
                    <div><strong>üìÖ ${ev.data} - ${ev.nome}</strong> (${ev.participantes.length} presentes)</div>
                    <div>
                        <button onclick="excluirHistorico(${ev.id})" class="btn-excluir">Apagar</button>
                    </div>
                </div>`;
        });
    }

    function excluirHistorico(id) {
        if(confirm("Apagar hist√≥rico?")) {
            historicoEventos = historicoEventos.filter(ev => ev.id !== id);
            localStorage.setItem('historicoEventos', JSON.stringify(historicoEventos));
            renderizarHistorico();
        }
    }

    function copiarLink() {
        navigator.clipboard.writeText(document.getElementById('linkGerado').innerText);
        alert("Link seguro copiado!");
    }

    function limparCampos() { document.querySelectorAll('.form-group input').forEach(i => i.value = ''); }

    popularFiltroLideres();
    atualizarTabelaGeral();
    atualizarTabelaEvento();
    renderizarHistorico();
</script>
</body>
</html>
