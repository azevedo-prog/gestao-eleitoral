<script>
    // Suas chaves de configuração do Firebase aqui...
    const firebaseConfig = {
        // ... cole suas chaves aqui ...
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const MEU_TITULO = "074635610418";

    // ESCUTA A NUVEM EM TEMPO REAL
    function ouvirNuvem() {
        // Atualiza Lista de Eleitores e Rankings
        db.ref('eleitores').on('value', s => {
            const lista = s.val() ? Object.entries(s.val()).map(item => ({id: item[0], ...item[1]})) : [];
            renderTabela(lista);
            renderRankings(lista);
        });

        // Atualiza Lista de Presença do Evento Atual
        db.ref('presencas').on('value', s => {
            const presencas = s.val() ? Object.values(s.val()) : [];
            renderListaPresenca(presencas);
        });
    }

    // RENDERIZA A TABELA PRINCIPAL
    function renderTabela(dados) {
        const tbody = document.querySelector("#tabelaMaster tbody");
        tbody.innerHTML = "";
        
        dados.forEach(p => {
            // Conta quantos indicados esse líder possui
            const indicados = dados.filter(x => x.lider === p.slug).length;
            const meta = 10;
            const statusColor = indicados >= meta ? 'var(--success)' : 'var(--danger)';
            const statusTexto = indicados >= meta ? 'ATIVO' : 'INATIVO';

            tbody.innerHTML += `
                <tr>
                    <td><span class="status-badge" style="background:${statusColor}">${statusTexto}</span></td>
                    <td><b>${p.nome}</b></td>
                    <td>${p.cidade}</td>
                    <td>${p.titulo}</td>
                    <td>${p.zona}/${p.secao}</td>
                    <td>${indicados} / ${meta}</td>
                    <td>${p.lider}</td>
                    <td>
                        <button onclick="registrarPresenca('${p.nome}', '${p.cidade}')" class="btn-presenca" style="background:var(--success); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">PRESENÇA</button>
                        <button onclick="excluir('${p.id}')" style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">X</button>
                    </td>
                </tr>`;
        });
    }

    // FUNÇÃO PARA O BOTÃO VERDE "PRESENÇA"
    function registrarPresenca(nome, cidade) {
        const eventoAtual = "Aniversário do Líder Azevedo 12/06/2026"; // Pega o nome do evento
        
        db.ref('presencas').push({
            nome: nome,
            cidade: cidade,
            evento: eventoAtual,
            dataHora: new Date().toLocaleString()
        });
        alert("Presença confirmada para: " + nome);
    }

    // ATUALIZA A MINI-TABELA DE CONFIRMADOS ABAIXO DO EVENTO
    function renderListaPresenca(presencas) {
        const area = document.querySelector("#listaPresencaConfirmados"); // Certifique-se de ter esse ID no seu HTML
        if(!area) return;
        
        document.getElementById('totalConfirmados').innerText = presencas.length;
        area.innerHTML = presencas.map(p => `
            <tr>
                <td>${p.nome}</td>
                <td>${p.cidade}</td>
                <td>Confirmado ✅</td>
            </tr>
        `).join('');
    }

    // EXCLUIR REGISTRO
    function excluir(id) {
        if(confirm("Deseja realmente excluir este eleitor?")) {
            db.ref('eleitores').child(id).remove();
        }
    }

    // LOGIN E INICIALIZAÇÃO
    function verificarAcesso() {
        const t = document.getElementById('loginTitulo').value;
        if(t === MEU_TITULO) {
            document.getElementById('telaBloqueio').style.display = 'none';
            document.getElementById('painelAdmin').style.display = 'block';
            ouvirNuvem();
        } else {
            // Lógica para líderes verem apenas seus links...
        }
    }
</script>
